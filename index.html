<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>What the Package Does (One Line, Title Case) • OmopSparkConnector</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="What the Package Does (One Line, Title Case)">
<meta name="description" content="What the package does.">
<meta property="og:description" content="What the package does.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">OmopSparkConnector</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="articles/a01_getting_started.html">Getting started</a></li>
    <li><a class="dropdown-item" href="articles/a02_creating_a_databricks_cdm.html">Creating a databricks cdm reference</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="omopsparkconnector">OmopSparkConnector<a class="anchor" aria-label="anchor" href="#omopsparkconnector"></a>
</h1></div>
<!-- badges: start -->

<p>OmopSparkConnector provides a Spark specific implementation of an OMOP CDM reference as defined by the omopgenerics R package.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of OmopSparkConnector from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"oxford-pharmacoepi/OmopSparkConnector"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-a-cdm-reference-using-sparklyr">Creating a cdm reference using Sparklyr<a class="anchor" aria-label="anchor" href="#creating-a-cdm-reference-using-sparklyr"></a>
</h2>
<p>Let’s first load the R libraries.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://spark.posit.co/" class="external-link">sparklyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://oxford-pharmacoepi.github.io/OmopSparkConnector/">OmopSparkConnector</a></span><span class="op">)</span></span></code></pre></div>
<p>To work with OmopSparkConnector, we will first need to create a connection to our data using the sparklyr. In the example below, we have a schema called “omop” that contains all the OMOP CDM tables and then we have another schema where we can write results during the course of a study. We also set a write prefix so that all the tables we write start with this (which makes it easy to clean up afterwards and avoid any name conflicts with other users).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">sparklyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/spark-connections.html" class="external-link">spark_connect</a></span><span class="op">(</span><span class="va">.....</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/cdmFromSpark.html">cdmFromSpark</a></span><span class="op">(</span><span class="va">con</span>,</span>
<span>  cdmSchema <span class="op">=</span> <span class="st">"omop"</span>,</span>
<span>  writeSchema <span class="op">=</span> <span class="st">"results"</span>,</span>
<span>  writePrefix <span class="op">=</span> <span class="st">"study_1_"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For this introduction we’ll use a mock cdm where we have a small synthetic dataset in a local spark database.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/mockSparkCdm.html">mockSparkCdm</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"temp_spark"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ! Validation has been turned off, this is not recommended as analytical</span></span>
<span><span class="co">#&gt;   packages assumed the cdm_reference object fulfills the cdm validation</span></span>
<span><span class="co">#&gt;   criteria.</span></span>
<span><span class="co">#&gt; ! Validation has been turned off, this is not recommended as analytical</span></span>
<span><span class="co">#&gt;   packages assumed the cdm_reference object fulfills the cdm validation</span></span>
<span><span class="co">#&gt;   criteria.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cross-platform-support">Cross platform support<a class="anchor" aria-label="anchor" href="#cross-platform-support"></a>
</h2>
<p>With our cdm reference created, we now a single object in R that represents our OMOP CDM data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── # OMOP CDM reference (sparklyr) of mock local spark ─────────────────────────</span></span>
<span><span class="co">#&gt; • omop tables: cdm_source, concept, concept_ancestor, concept_relationship,</span></span>
<span><span class="co">#&gt; concept_synonym, condition_occurrence, drug_strength, observation_period,</span></span>
<span><span class="co">#&gt; person, vocabulary</span></span>
<span><span class="co">#&gt; • cohort tables: -</span></span>
<span><span class="co">#&gt; • achilles tables: -</span></span>
<span><span class="co">#&gt; • other tables: -</span></span></code></pre></div>
<p>This object contains references to each of our tables</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span><span class="op">$</span><span class="va">person</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: ??</span></span>
<span><span class="co">#&gt; Columns: 18</span></span>
<span><span class="co">#&gt; Database: spark_connection</span></span>
<span><span class="co">#&gt; $ person_id                   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10</span></span>
<span><span class="co">#&gt; $ gender_concept_id           &lt;int&gt; 8507, 8532, 8532, 8507, 8507, 8507, 8507, …</span></span>
<span><span class="co">#&gt; $ year_of_birth               &lt;int&gt; 1960, 1969, 1976, 1981, 1987, 1953, 1999, …</span></span>
<span><span class="co">#&gt; $ month_of_birth              &lt;int&gt; 6, 3, 11, 3, 12, 10, 5, 12, 10, 4</span></span>
<span><span class="co">#&gt; $ day_of_birth                &lt;int&gt; 24, 7, 12, 2, 26, 31, 29, 10, 17, 25</span></span>
<span><span class="co">#&gt; $ race_concept_id             &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ ethnicity_concept_id        &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ birth_datetime              &lt;dttm&gt; 1970-01-01 01:00:00, 1970-01-01 01:00:00, …</span></span>
<span><span class="co">#&gt; $ location_id                 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ provider_id                 &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ care_site_id                &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ person_source_value         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ gender_source_value         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ gender_source_concept_id    &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ race_source_value           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ race_source_concept_id      &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ ethnicity_source_value      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span><span class="co">#&gt; $ ethnicity_source_concept_id &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">observation_period</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: ??</span></span>
<span><span class="co">#&gt; Columns: 5</span></span>
<span><span class="co">#&gt; Database: spark_connection</span></span>
<span><span class="co">#&gt; $ observation_period_id         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10</span></span>
<span><span class="co">#&gt; $ person_id                     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10</span></span>
<span><span class="co">#&gt; $ observation_period_start_date &lt;date&gt; 1990-05-26, 1980-12-06, 2004-02-22, 2017…</span></span>
<span><span class="co">#&gt; $ observation_period_end_date   &lt;date&gt; 2009-03-08, 1981-08-30, 2006-01-11, 2018…</span></span>
<span><span class="co">#&gt; $ period_type_concept_id        &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA</span></span></code></pre></div>
<p>With this we can use familiar dplyr code . For example, we can quickly get a count of our person table.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span><span class="op">$</span><span class="va">person</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Source:   SQL [?? x 1]</span></span>
<span><span class="co">#&gt; # Database: spark_connection</span></span>
<span><span class="co">#&gt;       n</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1    10</span></span></code></pre></div>
<p>Behind the scenes, the dbplyr R package is translating this to SQL.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span><span class="op">$</span><span class="va">person</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; SELECT COUNT(*) AS `n`</span></span>
<span><span class="co">#&gt; FROM omop.person</span></span></code></pre></div>
<p>We can also make use of various existing packages that work with a cdm reference using this approach. For example, we can extract a summary of missing data in our condition occurrence table using the OmopSketch package.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://OHDSI.github.io/OmopSketch/" class="external-link">OmopSketch</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ardata-fr.github.io/flextable-book/" class="external-link">flextable</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">missing_condition_data</span> <span class="op">&lt;-</span> <span class="fu">OmopSketch</span><span class="fu">::</span><span class="fu"><a href="https://OHDSI.github.io/OmopSketch/reference/summariseMissingData.html" class="external-link">summariseMissingData</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="st">"condition_occurrence"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://OHDSI.github.io/OmopSketch/reference/tableMissingData.html" class="external-link">tableMissingData</a></span><span class="op">(</span><span class="va">missing_condition_data</span>, type <span class="op">=</span> <span class="st">"flextable"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-9-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="native-spark-support">Native spark support<a class="anchor" aria-label="anchor" href="#native-spark-support"></a>
</h2>
<p>As well as making use of packages that provide cross-platform functionality with the cdm reference such as OmopSketch, because OmopSparkConnector is built on top of the sparklyr package we can also make use of native spark queries. For example we can compute summary statistics on one of our cdm tables using spark functions.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span><span class="op">$</span><span class="va">person</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sparklyr/man/sdf_describe.html" class="external-link">sdf_describe</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"gender_concept_id"</span>,</span>
<span>    <span class="st">"year_of_birth"</span>,</span>
<span>    <span class="st">"month_of_birth"</span>,</span>
<span>    <span class="st">"day_of_birth"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Source:   table&lt;`sparklyr_tmp_08565f48_368a_4fd3_996d_6ce84d0937eb`&gt; [?? x 5]</span></span>
<span><span class="co">#&gt; # Database: spark_connection</span></span>
<span><span class="co">#&gt;   summary gender_concept_id  year_of_birth      month_of_birth     day_of_birth </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;              &lt;chr&gt;              &lt;chr&gt;              &lt;chr&gt;        </span></span>
<span><span class="co">#&gt; 1 count   10                 10                 10                 10           </span></span>
<span><span class="co">#&gt; 2 mean    8519.5             1974.7             7.6                18.3         </span></span>
<span><span class="co">#&gt; 3 stddev  13.176156917368234 15.867857098199766 3.7475918193480524 10.089047967…</span></span>
<span><span class="co">#&gt; 4 min     8507               1953               3                  2            </span></span>
<span><span class="co">#&gt; 5 max     8532               1999               12                 31</span></span></code></pre></div>
<p>With this we are hopefully achieving the best of both worlds. On the one hand we can participate in network studies where code has been written in such a way to work across database platforms. And then on the other we are able to go beyond this approach, writing bespoke code that makes use of Spark-specific functionality.</p>
</div>
</div>
<div class="section level1">
<h1 id="disconnecting-from-your-spark-connection">Disconnecting from your spark connection<a class="anchor" aria-label="anchor" href="#disconnecting-from-your-spark-connection"></a>
</h1>
<p>We can disconnect from our spark connection like so</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/cdmDisconnect.html" class="external-link">cdmDisconnect</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">)</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>Apache License (&gt;= 2)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing OmopSparkConnector</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>First Last <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/YOUR-ORCID-ID" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/oxford-pharmacoepi/OmopSparkConnector/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/oxford-pharmacoepi/OmopSparkConnector/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
